<!DOCTYPE html>
<html>
  <head>
    <!-- <script type="text/javascript" src="https://login.persona.org/provisioning_api.js"></script> -->
    <script type="text/javascript" src="http://localhost:10002/provisioning_api.js"></script>
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="http://127.0.0.1:26600/js/persona.js"></script> -->
    <script type="text/javascript">
      function activeSessionFor(email) {
        // In here, we ask the server if this email has an active session
        // TODO: Implementation
        return true;
      }

      function generateCert(email, pubKey, certDuration, callback) {
        // Call to backend to generate cert
        console.log(document.location);
        $.ajax({
          url: 'http://127.0.0.1:8080/cert_key',
          data : {
            pubkey: pubKey,
            duration: certDuration,
            email: email
          },
          type: 'POST',
          header: {"Content-Type": "application/json"},
          success: function (data) {
            if (data.success) {
              callback(data.certificate);
            } else {
              console.log("COULD NOT CERTIFY KEY");
              navigator.id.raiseProvisioningFailure('Could not certify key');
            }
          },
          error: function(data) {
            console.log(data.reason);
            navigator.id.raiseProvisioningFailure('Could not connect to certifer');
          }
        });
      }

      function startProvisioning() {
        navigator.id.beginProvisioning(function(email, certDuration) {
          if (activeSessionFor(email)) {
            navigator.id.genKeyPair(function(publicKey) {
              generateCert(email, publicKey, certDuration, function (certificate) {
                navigator.id.registerCertificate(certificate);
              });
            });
          } else {
            navigator.id.raiseProvisioningFailure('user is not authenticated as target user');
          }
        });
      }

      startProvisioning();

    </script>
    </head>
  </html>
